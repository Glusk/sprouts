name: Automated Comment Release
on:
  issue_comment:
    types: [created]
jobs:
  release:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, 'Github, please release version:')
    env:
      MSG_REGEX: "Github, please release version: v[0-9]+.[0-9]+.[0-9]+"
      TAG_REGEX: "v[0-9]+.[0-9]+.[0-9]+"
    steps:
      - 
        name: "Notify that a new release has been started"
        run: |-
            curl --request POST \
            --url ${{ github.event.comment.issue_url }}/comments \
            --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
            --header 'content-type: application/json' \
            --data '{
              "body": "> ${{ github.event.comment.body }} \n\n A new automated release process has been started!"
              }'
      - name: Checkout master branch
        uses: actions/checkout@master
      - name: Install Java
        uses: actions/setup-java@v1
        with:
          java-version: 8
      - name: Install Android SDK
        uses: malinskiy/action-android/install-sdk@release/0.1.1
      - name: Install Android packages
        run: sdkmanager "platforms;android-28" "platform-tools" "build-tools;28.0.3"
      - name: Initialize Git user
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      - name: Tag a new release
        run: |
          # Get the tag from ${{ github.event.comment.body }}
          tag=$(echo ${{ github.event.comment.body }} | grep -E "$MSG_REGEX" | grep -Eo "$TAG_REGEX")
          if [[ $tag == "" ]]; then return -1; fi
          # Strip the 'v' prefix from the tag for version
          version=${tag#"v"}
          # Bump versions
          perl -i.orig -pe '/versionCode/ && s/([0-9]+)/$1+1 . $2/e' android/build.gradle
          chmod +x gradlew
          ./gradlew updateVersion -Prelease.useAutomaticVersion=true -Prelease.newVersion=$version
          if [[ $? ]]
          then
            # Tag the new version
            git commit -am "Bumped project version to $tag"
            git tag -a $tag -m "Release $tag"
            # Bump to snapshot
            ./gradlew updateVersion -Prelease.useAutomaticVersion=true -Prelease.newVersion=$version-SNAPSHOT
            git commit -am "Bumped project version to $tag-SNAPSHOT"
            # Notify
            curl --request POST \
            --url --url ${{ github.event.comment.issue_url }}/comments \
            --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
            --header 'content-type: application/json' \
            --data '{
              "body": "> ${{ github.event.comment.body }} \n\nSuccessfully released a new version! See [tags](https://github.com/${{ github.repository }}/tags/)."
              }'
          else
            return -1
          fi
      - 
        name: Error message
        if: failure()
        run: |-
            curl --request POST \
            --url ${{ github.event.comment.issue_url }}/comments \
            --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
            --header 'content-type: application/json' \
            --data '{
              "body": "> ${{ github.event.comment.body }} \n\nRelease failed!"
              }'
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tags: true
